@page "/transactions"
@using FinanceTrackerApp.Models
@using FinanceTrackerApp.Services
@inject TransactionService TransactionService
@inject NavigationManager NavigationManager

<div class="glass card">

    <div class="page-head">
        <div>
            <h2 style="margin:0;">Transactions</h2>
            <p style="margin:.25rem 0 0 0;">Manage your income and expenses.</p>
        </div>

        <a class="btn btn-primary" href="/add-transaction">+ Add Transaction</a>
    </div>

    <!-- FILTERS -->
    <div class="filters glass" style="margin-top:1rem;">
        <input class="input" placeholder="Search transactions..." @bind="searchTerm" @bind:event="oninput" />

        <select class="input" @bind="filterType">
            <option value="">All Types</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
        </select>

        <select class="input" @bind="filterCategory">
            <option value="">All Categories</option>
            <option>Food</option>
            <option>Transport</option>
            <option>Salary</option>
            <option>Rent</option>
        </select>
    </div>

    <!-- TRANSACTION TABLE -->
    <div class="table glass" style="margin-top:1rem;">
        <div class="table-row table-head">
            <div>Date</div>
            <div>Description</div>
            <div>Category</div>
            <div>Type</div>
            <div style="text-align:right;">Amount</div>
            <div>Actions</div>
        </div>

        @foreach (var tx in FilteredTransactions)
        {
            var currentTx = tx;

            <div class="table-row" @key="currentTx.TransactionId">
                <div class="muted">@currentTx.Date.ToShortDateString()</div>
                <div class="strong">@currentTx.Description</div>
                <div><span class="pill">@currentTx.Category</span></div>
                <div><span class="badge @(currentTx.Type=="income"?"badge-income":"badge-expense")">@currentTx.Type</span></div>
                <div class="amount @(currentTx.Type=="income"?"income":"expense")" style="text-align:right;">
                    @(currentTx.Type=="income"?"+":"-") $@currentTx.Amount
                </div>
                <div>
                    <a class="btn btn-sm btn-primary" href="@($"/edit-transaction/{currentTx.TransactionId}")">Edit</a>
                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteTransaction(currentTx)">Delete</button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private List<Transaction> transactions = new();

    private string searchTerm = "";
    private string filterType = "";
    private string filterCategory = "";

    protected override async Task OnInitializedAsync()
    {
        transactions = await TransactionService.GetAllAsync();
    }

    private IEnumerable<Transaction> FilteredTransactions => transactions
        .Where(t =>
            (string.IsNullOrEmpty(searchTerm) || t.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrEmpty(filterType) || t.Type == filterType) &&
            (string.IsNullOrEmpty(filterCategory) || t.Category == filterCategory));

    private async Task DeleteTransaction(Transaction tx)
    {
        await TransactionService.DeleteAsync(tx.TransactionId);
        transactions.Remove(tx);
    }
}
