@page "/add-transaction"
@attribute [Authorize]
@using FinanceTrackerApp.Models
@using FinanceTrackerApp.Services
@inject TransactionService TransactionService
@inject AuthService AuthService
@inject CategoryService CategoryService
@inject NavigationManager NavigationManager

<EditForm Model="@newTx" OnValidSubmit="SaveTransaction">
    <DataAnnotationsValidator />
    <ValidationSummary class="validation-summary" />
    <div class="glass card" style="padding:1rem; max-width:500px; margin:auto;">
        @if (!string.IsNullOrWhiteSpace(formError))
        {
            <div class="alert">@formError</div>
        }
        <h2 class="strong" style="color: var(--text);">Add Transaction</h2>
        <p style=" margin-bottom: 15px">Add a new transaction to keep track of.</p>

        <div class="form-grid" style="display:grid; gap:.5rem;">
            <div class="field">
                <label>Amount (USD)</label>
                <input class="input" type="number" @bind="newTx.Amount" placeholder="0.00" />
            </div>

            <div class="field">
                <label>Type</label>
                <select class="input" @bind="newTx.Type">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
            </div>

            <div class="field">
                <label>Date</label>
                <input type="date" class="input" @bind="newTx.Date" />
            </div>

            <div class="field">
                <label>Category</label>
                <div style="display:flex; gap:.5rem; align-items:center;">
                    <select class="input" @bind="newTx.Category" style="flex:1;">
                        @foreach (var category in CategoryOptions)
                        {
                            <option value="@category">@category</option>
                        }
                    </select>
                    <button type="button" class="btn btn-xs" @onclick="OpenQuickAddCategory">+ New</button>
                </div>
                @if (!string.IsNullOrWhiteSpace(categoryMessage))
                {
                    <small class="muted">@categoryMessage</small>
                }
            </div>

            <div class="field">
                <label>Description</label>
                <input class="input" type="text" @bind="newTx.Description" placeholder="Optional description" />
            </div>

            <div style="margin-top:1rem; margin: auto;">
                <button type="submit" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-ghost" @onclick="Cancel">Cancel</button>
            </div>
        </div>
    </div>
</EditForm>

<Modal @bind-IsOpen="isCategoryModalOpen" Title="Add Category">
    <ChildContent>
        <div class="form-grid">
            <div class="field">
                <label>Name</label>
                <input class="input" @bind="newCategoryName" placeholder="e.g. Groceries" />
            </div>
            <div class="field">
                <label>Color</label>
                <input class="input" type="color" @bind="newCategoryColor" />
            </div>
        </div>
    </ChildContent>
    <FooterContent>
        <button class="btn btn-ghost" @onclick="CloseQuickAddCategory">Cancel</button>
        <button class="btn btn-primary" @onclick="SaveQuickCategoryAsync">Save Category</button>
    </FooterContent>
</Modal>

@code {
    private Transaction newTx = new Transaction
    {
        Date = DateTime.Today,
        Type = "expense"
    };
    private string _currentUserId = "";
    private List<Category> userCategories = new();
    private bool isCategoryModalOpen;
    private string newCategoryName = "";
    private string newCategoryColor = "#2BEF83";
    private string categoryMessage = "";
    private string formError = "";

    protected override async Task OnInitializedAsync()
    {
        _currentUserId = await AuthService.GetCurrentUserIdAsync();
        await LoadCategoriesAsync();
        if (string.IsNullOrWhiteSpace(newTx.Category))
        {
            newTx.Category = CategoryOptions.FirstOrDefault() ?? "General";
        }
    }

    private async Task SaveTransaction()
    {
        formError = "";
        try
        {
            newTx.UserId = _currentUserId;
            await TransactionService.AddAsync(newTx);
            NavigationManager.NavigateTo("/transactions");
        }
        catch
        {
            formError = "Could not save transaction right now. Please try again.";
        }
    }

    private async Task LoadCategoriesAsync()
    {
        userCategories = await CategoryService.GetByUserAsync(_currentUserId);
    }

    private IEnumerable<string> CategoryOptions =>
        userCategories
            .Select(c => c.Name)
            .Where(name => !string.IsNullOrWhiteSpace(name))
            .DefaultIfEmpty("General")
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(name => name);

    private void OpenQuickAddCategory()
    {
        categoryMessage = "";
        newCategoryName = "";
        newCategoryColor = "#2BEF83";
        isCategoryModalOpen = true;
    }

    private void CloseQuickAddCategory()
    {
        isCategoryModalOpen = false;
    }

    private async Task SaveQuickCategoryAsync()
    {
        var name = (newCategoryName ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(name))
        {
            categoryMessage = "Category name is required.";
            return;
        }

        if (userCategories.Any(c => string.Equals(c.Name, name, StringComparison.OrdinalIgnoreCase)))
        {
            categoryMessage = "Category already exists.";
            return;
        }

        await CategoryService.AddAsync(new Category { Name = name, Color = newCategoryColor }, _currentUserId);
        await LoadCategoriesAsync();
        newTx.Category = name;
        categoryMessage = $"Added '{name}'.";
        isCategoryModalOpen = false;
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/transactions");
    }
}
