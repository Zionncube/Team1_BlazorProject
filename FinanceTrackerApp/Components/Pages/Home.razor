@page "/"
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using FinanceTrackerApp.Services
@using FinanceTrackerApp.Models
@attribute [Authorize]
@inject ProtectedLocalStorage Storage
@inject IGoalsStore GoalsStore
@inject AuthService AuthService
@inject TransactionService TransactionService

<div class="glass card">
    <h2>Dashboard</h2>

    <div class="kpis">
        <div class="glass kpi">
            <div class="label">Total Balance</div>
            <div class="value @(summary.TotalBalance >= 0 ? "positive" : "negative")">@FormatMoney(summary.TotalBalance)</div>
        </div>

        <div class="glass kpi">
            <div class="label">Monthly Income</div>
            <div class="value income">@FormatMoney(summary.TotalIncomeThisMonth)</div>
        </div>

        <div class="glass kpi">
            <div class="label">Monthly Expenses</div>
            <div class="value negative">@FormatMoney(summary.TotalExpensesThisMonth)</div>
        </div>
    </div>

    <div class="kpis" style="margin-top: .8rem;">
        <div class="glass kpi">
            <div class="label">Top Category</div>
            <div class="value">@summary.TopCategory</div>
        </div>
        <div class="glass kpi">
            <div class="label">Transactions</div>
            <div class="value">@summary.TransactionsCount</div>
        </div>
    </div>

    @if (ShowGoals && FeaturedGoal != null)
    {
        <div style="margin-top: 1.1rem;">
            <h2 style="margin-bottom: .6rem;">Savings Goals</h2>
            <div class="glass card" style="background: rgba(255,255,255,0.05); padding: 1rem;">
                <div class="tx-title">@FeaturedGoal.Title</div>
                <div class="progress-bar" style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; margin: 8px 0;">
                    <div style="background: var(--primary); width: @(GetProgress(FeaturedGoal))%; height: 100%; border-radius: 4px;"></div>
                </div>
                <div class="tx-sub">@(GetProgress(FeaturedGoal))% of @FormatMoney(FeaturedGoal.TargetAmount) saved</div>
            </div>
        </div>
    }

    <div style="margin-top: 1.1rem;">
        <h2 style="margin-bottom: .6rem;">Recent Transactions</h2>

        @if (!recentTransactions.Any())
        {
            <div class="tx">
                <div class="tx-left">
                    <div class="tx-icon">-</div>
                    <div>
                        <div class="tx-title">No transactions yet</div>
                        <div class="tx-sub">Add your first transaction from the Transactions page.</div>
                    </div>
                </div>
            </div>
        }
        else
        {
            @foreach (var tx in recentTransactions)
            {
                var isIncome = string.Equals(tx.Type, "income", StringComparison.OrdinalIgnoreCase);
                <div class="tx">
                    <div class="tx-left">
                        <div class="tx-icon">@(isIncome ? "+" : "-")</div>
                        <div>
                            <div class="tx-title">@tx.Description</div>
                            <div class="tx-sub">@tx.Category - @tx.Date.ToString("MMM dd")</div>
                        </div>
                    </div>
                    <div class="amount @(isIncome ? "income" : "expense")">
                        @(isIncome ? "+" : "-") @FormatMoney(tx.Amount)
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private bool ShowGoals = true;
    private string CurrencySymbol = "$";
    private SavingsGoal? FeaturedGoal;
    private DashboardSummary summary = new();
    private List<Transaction> recentTransactions = new();

    protected override async Task OnInitializedAsync()
    {
        var goalsReq = await Storage.GetAsync<bool>("pref_show_goals");
        ShowGoals = goalsReq.Success ? goalsReq.Value : true;

        var currencyReq = await Storage.GetAsync<string>("pref_currency");
        if (currencyReq.Success && !string.IsNullOrEmpty(currencyReq.Value))
        {
            CurrencySymbol = currencyReq.Value switch
            {
                "NGN" => "NGN",
                "EUR" => "EUR",
                _ => "USD"
            };
        }

        var session = await AuthService.GetSessionAsync();
        if (session != null && !string.IsNullOrEmpty(session.LocalId))
        {
            var goals = await GoalsStore.GetGoalsAsync(session.LocalId);
            FeaturedGoal = goals.FirstOrDefault();

            summary = await TransactionService.GetDashboardSummaryAsync(session.LocalId);
            recentTransactions = (await TransactionService.GetTransactionsAsync(session.LocalId))
                .Take(5)
                .ToList();
        }
    }

    private int GetProgress(SavingsGoal goal)
    {
        if (goal.TargetAmount <= 0) return 0;
        return (int)((goal.CurrentAmount / goal.TargetAmount) * 100);
    }

    private string FormatMoney(decimal amount)
    {
        return $"{CurrencySymbol} {amount:N2}";
    }
}
