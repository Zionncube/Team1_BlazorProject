@page "/"
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using FinanceTrackerApp.Services
@using FinanceTrackerApp.Models
@attribute [Authorize]
@inject ProtectedLocalStorage Storage
@inject IGoalsStore GoalsStore
@inject AuthService AuthService

<div class="glass card">
    <h2>Dashboard</h2>

    <div class="kpis">
        <div class="glass kpi">
            <div class="label">Total Balance</div>
            <div class="value positive">@CurrencySymbol 12,540</div>
        </div>

        <div class="glass kpi">
            <div class="label">Monthly Income</div>
            <div class="value income">@CurrencySymbol 4,850</div>
        </div>

        <div class="glass kpi">
            <div class="label">Monthly Expenses</div>
            <div class="value negative">@CurrencySymbol 1,920</div>
        </div>
    </div>

    @if (ShowGoals && FeaturedGoal != null)
    {
        <div style="margin-top: 1.1rem;">
            <h2 style="margin-bottom: .6rem;">Savings Goals</h2>
            <div class="glass card" style="background: rgba(255,255,255,0.05); padding: 1rem;">
                <div class="tx-title">@FeaturedGoal.Title</div>
                <div class="progress-bar" style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; margin: 8px 0;">
                    <div style="background: var(--primary); width: @(GetProgress(FeaturedGoal))%; height: 100%; border-radius: 4px;"></div>
                </div>
                <div class="tx-sub">@(GetProgress(FeaturedGoal))% of @CurrencySymbol @FeaturedGoal.TargetAmount saved</div>
            </div>
        </div>
    }

    <div style="margin-top: 1.1rem;">
        <h2 style="margin-bottom: .6rem;">Recent Transactions</h2>

        <div class="tx">
            <div class="tx-left">
                <div class="tx-icon">ðŸ›’</div>
                <div>
                    <div class="tx-title">Groceries</div>
                    <div class="tx-sub">Food â€¢ Today</div>
                </div>
            </div>
            <div class="amount expense">- @CurrencySymbol 28.40</div>
        </div>

        <div class="tx">
            <div class="tx-left">
                <div class="tx-icon">ðŸš•</div>
                <div>
                    <div class="tx-title">Transport</div>
                    <div class="tx-sub">Taxi â€¢ Yesterday</div>
                </div>
            </div>
            <div class="amount expense">- @CurrencySymbol 12.00</div>
        </div>

        <div class="tx">
            <div class="tx-left">
                <div class="tx-icon">ðŸ’¼</div>
                <div>
                    <div class="tx-title">Salary</div>
                    <div class="tx-sub">Income â€¢ Jan 25</div>
                </div>
            </div>
            <div class="amount income">+ @CurrencySymbol 1,200.00</div>
        </div>
    </div>
</div>

@code {
    private bool ShowGoals = true;
    private string CurrencySymbol = "$";
    private SavingsGoal? FeaturedGoal;

    protected override async Task OnInitializedAsync()
    {
        var goalsReq = await Storage.GetAsync<bool>("pref_show_goals");
        ShowGoals = goalsReq.Success ? goalsReq.Value : true;

        var currencyReq = await Storage.GetAsync<string>("pref_currency");
        if (currencyReq.Success && !string.IsNullOrEmpty(currencyReq.Value))
        {
            CurrencySymbol = currencyReq.Value switch
            {
                "NGN" => "â‚¦",
                "EUR" => "â‚¬",
                _ => "$"
            };
        }

        var session = await AuthService.GetSessionAsync();
        if (session != null && !string.IsNullOrEmpty(session.LocalId))
        {
            var goals = await GoalsStore.GetGoalsAsync(session.LocalId);
            FeaturedGoal = goals.FirstOrDefault();
        }
    }

    private int GetProgress(SavingsGoal goal)
    {
        if (goal.TargetAmount <= 0) return 0;
        return (int)((goal.CurrentAmount / goal.TargetAmount) * 100);
    }
}