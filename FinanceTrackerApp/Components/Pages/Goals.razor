@using FinanceTrackerApp.Components.Shared
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@page "/goals"
@attribute [Authorize]
@rendermode InteractiveServer
@using FinanceTrackerApp.Models
@using System.Globalization
@inject FinanceTrackerApp.Services.IGoalsStore GoalsStore
@inject FinanceTrackerApp.Services.AuthService AuthService

<PageTitle>Goals</PageTitle>

<section class="page">
    <header class="page-header">
        <div>
            <h1 class="title">Savings Goals</h1>
            <p class="subtitle">Track your progress and stay consistent.</p>
        </div>

        <div class="actions">
            <button class="btn btn-ghost" @onclick="OpenAddMoney">
                + Add Money
            </button>

            <button class="btn btn-primary" @onclick="OpenAddGoal">
                + Add Goal
            </button>
        </div>
    </header>

    <div class="grid goals-grid">
        @foreach (var goal in goals.OrderByDescending(g => g.CreatedAt))
        {
            var percent = GetProgressPercent(goal);
            var remaining = Math.Max(0, goal.TargetAmount - goal.CurrentAmount);
            var goalContributions = contributions
                .Where(c => c.GoalId == goal.GoalId)
                .OrderByDescending(c => c.Date)
                .ToList();

            <article class="goal-card" style="--accent:@goal.Color">
                <div class="goal-top">
                    <div class="goal-badge">GOAL</div>
                    <div class="goal-menu">
                        <button class="icon-btn" title="Edit goal" @onclick="() => OpenEditGoal(goal)">Edit</button>
                        <button class="icon-btn" title="Mark complete" @onclick="() => ToggleComplete(goal)">
                            @(goal.IsCompleted ? "Done" : "Open")
                        </button>
                        <button class="icon-btn danger" title="Delete goal" @onclick="() => OpenDeleteConfirm(goal)">
                            Del
                        </button>
                    </div>
                </div>

                <h3 class="goal-title">@goal.Title</h3>

                @if (!string.IsNullOrWhiteSpace(goal.Description))
                {
                    <p class="goal-desc">@goal.Description</p>
                }

                <div class="goal-stats">
                    <div class="progress-ring" style="--percent:@percent">
                        <div class="progress-ring-inner">
                            <div class="ring-value">@percent%</div>
                            <div class="ring-label">Progress</div>
                        </div>
                    </div>
                    <div class="stat">
                        <span class="label">Saved</span>
                        <span class="value">@goal.CurrentAmount.ToString("C")</span>
                    </div>
                    <div class="stat">
                        <span class="label">Target</span>
                        <span class="value">@goal.TargetAmount.ToString("C")</span>
                    </div>
                </div>

                <div class="progress">
                    <div class="progress-bar" style="width:@percent%"></div>
                </div>

                <div class="goal-bottom">
                    <span class="progress-text">@percent% complete</span>

                    <span class="remaining">
                        Remaining: <strong>@remaining.ToString("C")</strong>
                    </span>
                </div>

                @if (goal.TargetDate is not null)
                {
                    <div class="goal-deadline">
                        Target date: <strong>@goal.TargetDate.Value.ToString("dd MMM yyyy")</strong>
                    </div>
                }

                <div class="goal-footer">
                    <button class="btn btn-soft" @onclick="() => OpenContribute(goal)">
                        + Add money to this goal
                    </button>
                    <button class="btn btn-ghost" @onclick="() => OpenHistory(goal)">History</button>
                </div>

                @if (goalContributions.Any())
                {
                    <div class="goal-history">
                        <div class="history-head">
                            <span>Recent contributions</span>
                            <button class="link" @onclick="() => OpenHistory(goal)">View all</button>
                        </div>
                        @foreach (var item in goalContributions.Take(3))
                        {
                            <div class="history-row">
                                <div class="history-date">@item.Date.ToString("dd MMM yyyy")</div>
                                <div class="history-note">@item.Note</div>
                                <div class="history-amount">@item.Amount.ToString("C")</div>
                            </div>
                        }
                    </div>
                }
            </article>
        }
    </div>

    @if (!goals.Any())
    {
        <div class="empty">
            <h2>No goals yet</h2>
            <p>Create your first savings goal and start tracking your progress.</p>
            <button class="btn btn-primary" @onclick="OpenAddGoal">+ Add Goal</button>
        </div>
    }
</section>

<!-- ADD GOAL MODAL -->
<Modal IsOpen="@isAddGoalOpen"
       IsOpenChanged="@(v => isAddGoalOpen = v)"
       Title="Create a Savings Goal"
       Subtitle="Set a target amount and optional deadline.">

    <ChildContent>
        @if (!string.IsNullOrWhiteSpace(goalCreateError))
        {
            <div class="alert">@goalCreateError</div>
        }
        <div class="form-grid">
            <div class="field">
                <label>Goal title</label>
                <input class="input" placeholder="e.g. Save for Laptop"
                       @bind="goalForm.Title" />
            </div>

            <div class="field">
                <label>Description (optional)</label>
                <input class="input" placeholder="Short note..."
                       @bind="goalForm.Description" />
            </div>

            <div class="field">
                <label>Target amount</label>
                <input class="input" type="number" step="0.01"
                       @bind="goalForm.TargetAmount" />
            </div>

            <div class="field">
                <label>Start saved amount</label>
                <input class="input" type="number" step="0.01"
                       @bind="goalForm.CurrentAmount" />
            </div>

            <div class="field">
                <label>Theme color</label>
                <input class="input" type="color" @bind="goalForm.Color" />
            </div>

            <div class="field">
                <label>Target date (optional)</label>
                <input class="input" type="date"
                       value="@goalTargetDateString"
                       @onchange="OnTargetDateChanged" />
            </div>
        </div>
    </ChildContent>

    <FooterContent>
        <button class="btn btn-ghost" @onclick="CloseAddGoal">Cancel</button>
        <button class="btn btn-primary" @onclick="CreateGoal">Create Goal</button>
    </FooterContent>
</Modal>

<!-- ADD MONEY MODAL -->
<Modal IsOpen="@isAddMoneyOpen"
       IsOpenChanged="@(v => isAddMoneyOpen = v)"
       Title="Add Money"
       Subtitle="Choose a goal and add a contribution.">

    <ChildContent>
        <div class="form-grid">
            <div class="field">
                <label>Select goal</label>
                <select class="input" @bind="selectedGoalId">
                    @foreach (var g in goals)
                    {
                        <option value="@g.GoalId">@g.Title</option>
                    }
                </select>
            </div>

            <div class="field">
                <label>Amount</label>
                <input class="input" type="number" step="0.01" @bind="contributionAmount" />
            </div>

            <div class="field">
                <label>Note (optional)</label>
                <input class="input" placeholder="e.g. bonus, side hustle..."
                       @bind="contributionNote" />
            </div>

            <div class="field">
                <label>Date</label>
                <input class="input" type="date"
                       value="@contributionDateString"
                       @onchange="OnContributionDateChanged" />
            </div>
        </div>
    </ChildContent>

    <FooterContent>
        <button class="btn btn-ghost" @onclick="CloseAddMoney">Cancel</button>
        <button class="btn btn-primary" @onclick="AddMoney">Add Money</button>
    </FooterContent>
</Modal>

<!-- EDIT GOAL MODAL -->
<Modal IsOpen="@isEditGoalOpen"
       IsOpenChanged="@(v => isEditGoalOpen = v)"
       Title="Edit Goal"
       Subtitle="Update the details for this savings goal.">

    <ChildContent>
        <div class="form-grid">
            <div class="field">
                <label>Goal title</label>
                <input class="input" placeholder="e.g. Save for Laptop"
                       @bind="editGoalForm.Title" />
            </div>

            <div class="field">
                <label>Description (optional)</label>
                <input class="input" placeholder="Short note..."
                       @bind="editGoalForm.Description" />
            </div>

            <div class="field">
                <label>Target amount</label>
                <input class="input" type="number" step="0.01"
                       @bind="editGoalForm.TargetAmount" />
            </div>

            <div class="field">
                <label>Current amount</label>
                <input class="input" type="number" step="0.01"
                       @bind="editGoalForm.CurrentAmount" />
            </div>

            <div class="field">
                <label>Theme color</label>
                <input class="input" type="color" @bind="editGoalForm.Color" />
            </div>

            <div class="field">
                <label>Target date (optional)</label>
                <input class="input" type="date"
                       value="@editGoalTargetDateString"
                       @onchange="OnEditTargetDateChanged" />
            </div>
        </div>
    </ChildContent>

    <FooterContent>
        <button class="btn btn-ghost" @onclick="CloseEditGoal">Cancel</button>
        <button class="btn btn-primary" @onclick="SaveEditedGoal">Save Changes</button>
    </FooterContent>
</Modal>

<!-- DELETE CONFIRM MODAL -->
<Modal IsOpen="@isDeleteConfirmOpen"
       IsOpenChanged="@(v => isDeleteConfirmOpen = v)"
       Title="Delete Goal"
       Subtitle="This action cannot be undone.">

    <ChildContent>
        <div class="confirm-body">
            <div class="confirm-title">Delete "@deleteGoalTitle"?</div>
            <div class="confirm-sub">All contributions for this goal will be removed.</div>
        </div>
    </ChildContent>

    <FooterContent>
        <button class="btn btn-ghost" @onclick="CloseDeleteConfirm">Cancel</button>
        <button class="btn btn-danger" @onclick="ConfirmDeleteGoal">Delete</button>
    </FooterContent>
</Modal>

<!-- CONTRIBUTION HISTORY MODAL -->
<Modal IsOpen="@isHistoryOpen"
       IsOpenChanged="@(v => isHistoryOpen = v)"
       Title="Contribution History"
       Subtitle="@historySubtitle">

    <ChildContent>
        @if (historyItems.Any())
        {
            <div class="history-list">
                @foreach (var item in historyItems)
                {
                    <div class="history-row">
                        <div class="history-date">@item.Date.ToString("dd MMM yyyy")</div>
                        <div class="history-note">@item.Note</div>
                        <div class="history-amount">@item.Amount.ToString("C")</div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty">No contributions yet for this goal.</div>
        }
    </ChildContent>

    <FooterContent>
        <button class="btn btn-primary" @onclick="CloseHistory">Close</button>
    </FooterContent>
</Modal>

@code {
    private List<SavingsGoal> goals = new();
    private List<GoalContribution> contributions = new();

    private bool isAddGoalOpen = false;
    private bool isAddMoneyOpen = false;
    private bool isEditGoalOpen = false;
    private bool isDeleteConfirmOpen = false;
    private bool isHistoryOpen = false;

    private SavingsGoal goalForm = new();
    private string goalTargetDateString = "";

    private SavingsGoal editGoalForm = new();
    private Guid editGoalId = Guid.Empty;
    private string editGoalTargetDateString = "";

    private Guid selectedGoalId;
    private decimal contributionAmount = 0;
    private string contributionNote = "";
    private string contributionDateString = DateTime.Today.ToString("yyyy-MM-dd");

    private Guid deleteGoalId = Guid.Empty;
    private string deleteGoalTitle = "";

    private string historySubtitle = "";
    private List<GoalContribution> historyItems = new();
    private string goalCreateError = "";

    private string currentUserId = "demo-user";

    protected override async Task OnInitializedAsync()
    {
        currentUserId = await AuthService.GetCurrentUserIdAsync();
        goals = await GoalsStore.GetGoalsAsync(currentUserId);
        contributions = await GoalsStore.GetContributionsAsync(currentUserId);
        selectedGoalId = goals.FirstOrDefault()?.GoalId ?? Guid.Empty;
    }

    private void OpenAddGoal()
    {
        goalCreateError = "";
        goalForm = new SavingsGoal
        {
            Title = "",
            Description = "",
            TargetAmount = 1000,
            CurrentAmount = 0,
            Color = "#2BEF83"
        };
        goalTargetDateString = "";
        isAddGoalOpen = true;
    }

    private void CloseAddGoal() => isAddGoalOpen = false;

    private async Task CreateGoal()
    {
        goalCreateError = "";

        goalForm.Title = goalForm.Title?.Trim() ?? "";
        if (string.IsNullOrWhiteSpace(goalForm.Title))
        {
            goalCreateError = "Please enter a goal title.";
            return;
        }

        if (goalForm.TargetAmount <= 0)
        {
            goalCreateError = "Target amount must be greater than 0.";
            return;
        }

        if (!string.IsNullOrWhiteSpace(goalTargetDateString) &&
            DateTime.TryParseExact(goalTargetDateString, "yyyy-MM-dd", CultureInfo.InvariantCulture,
                DateTimeStyles.None, out var dt))
        {
            goalForm.TargetDate = dt;
        }
        else
        {
            goalForm.TargetDate = null;
        }

        if (string.IsNullOrWhiteSpace(currentUserId))
            currentUserId = await AuthService.GetCurrentUserIdAsync();

        if (goalForm.GoalId == Guid.Empty)
            goalForm.GoalId = Guid.NewGuid();
        if (goalForm.CreatedAt == default)
            goalForm.CreatedAt = DateTime.Now;

        try
        {
            await GoalsStore.SaveGoalAsync(currentUserId, goalForm);
            goals.Insert(0, goalForm);
            isAddGoalOpen = false;
        }
        catch
        {
            goalCreateError = "Could not save goal right now. Please try again.";
        }
    }

    private void OpenAddMoney()
    {
        if (!goals.Any()) return;

        selectedGoalId = goals.First().GoalId;
        contributionAmount = 0;
        contributionNote = "";
        isAddMoneyOpen = true;
    }

    private void OpenContribute(SavingsGoal goal)
    {
        selectedGoalId = goal.GoalId;
        contributionAmount = 0;
        contributionNote = "";
        isAddMoneyOpen = true;
    }

    private void CloseAddMoney() => isAddMoneyOpen = false;

    private async Task AddMoney()
    {
        if (selectedGoalId == Guid.Empty || contributionAmount <= 0)
            return;

        var goal = goals.FirstOrDefault(g => g.GoalId == selectedGoalId);
        if (goal is null) return;

        DateTime contributionDate = DateTime.Today;
        DateTime.TryParseExact(contributionDateString, "yyyy-MM-dd", CultureInfo.InvariantCulture,
            DateTimeStyles.None, out contributionDate);

        goal.CurrentAmount += contributionAmount;

        if (goal.CurrentAmount >= goal.TargetAmount)
            goal.IsCompleted = true;

        var contribution = new GoalContribution
        {
            GoalId = goal.GoalId,
            Amount = contributionAmount,
            Date = contributionDate,
            Note = contributionNote
        };

        await GoalsStore.SaveGoalAsync(currentUserId, goal);
        await GoalsStore.AddContributionAsync(currentUserId, contribution);
        contributions.Add(contribution);

        isAddMoneyOpen = false;
    }

    private void ToggleComplete(SavingsGoal goal)
    {
        goal.IsCompleted = !goal.IsCompleted;
        _ = GoalsStore.SaveGoalAsync(currentUserId, goal);
    }

    private void OpenEditGoal(SavingsGoal goal)
    {
        editGoalId = goal.GoalId;
        editGoalForm = new SavingsGoal
        {
            GoalId = goal.GoalId,
            Title = goal.Title,
            Description = goal.Description,
            TargetAmount = goal.TargetAmount,
            CurrentAmount = goal.CurrentAmount,
            TargetDate = goal.TargetDate,
            IsCompleted = goal.IsCompleted,
            Color = goal.Color,
            CreatedAt = goal.CreatedAt
        };
        editGoalTargetDateString = goal.TargetDate?.ToString("yyyy-MM-dd") ?? "";
        isEditGoalOpen = true;
    }

    private void CloseEditGoal() => isEditGoalOpen = false;

    private async Task SaveEditedGoal()
    {
        var goal = goals.FirstOrDefault(g => g.GoalId == editGoalId);
        if (goal is null) return;

        if (!string.IsNullOrWhiteSpace(editGoalTargetDateString) &&
            DateTime.TryParseExact(editGoalTargetDateString, "yyyy-MM-dd", CultureInfo.InvariantCulture,
                DateTimeStyles.None, out var dt))
        {
            editGoalForm.TargetDate = dt;
        }
        else
        {
            editGoalForm.TargetDate = null;
        }

        goal.Title = editGoalForm.Title;
        goal.Description = editGoalForm.Description;
        goal.TargetAmount = editGoalForm.TargetAmount;
        goal.CurrentAmount = editGoalForm.CurrentAmount;
        goal.TargetDate = editGoalForm.TargetDate;
        goal.Color = editGoalForm.Color;

        if (goal.CurrentAmount >= goal.TargetAmount)
            goal.IsCompleted = true;

        await GoalsStore.SaveGoalAsync(currentUserId, goal);
        isEditGoalOpen = false;
    }

    private void OpenDeleteConfirm(SavingsGoal goal)
    {
        deleteGoalId = goal.GoalId;
        deleteGoalTitle = goal.Title;
        isDeleteConfirmOpen = true;
    }

    private void CloseDeleteConfirm() => isDeleteConfirmOpen = false;

    private async Task ConfirmDeleteGoal()
    {
        if (deleteGoalId == Guid.Empty) return;

        await GoalsStore.DeleteContributionsForGoalAsync(currentUserId, deleteGoalId);
        await GoalsStore.DeleteGoalAsync(currentUserId, deleteGoalId);

        goals.RemoveAll(g => g.GoalId == deleteGoalId);
        contributions.RemoveAll(c => c.GoalId == deleteGoalId);
        isDeleteConfirmOpen = false;
    }

    private void OpenHistory(SavingsGoal goal)
    {
        historySubtitle = goal.Title;
        historyItems = contributions
            .Where(c => c.GoalId == goal.GoalId)
            .OrderByDescending(c => c.Date)
            .ToList();
        isHistoryOpen = true;
    }

    private void CloseHistory() => isHistoryOpen = false;

    private int GetProgressPercent(SavingsGoal goal)
    {
        if (goal.TargetAmount <= 0) return 0;
        var p = (goal.CurrentAmount / goal.TargetAmount) * 100;
        return (int)Math.Clamp(Math.Round(p), 0, 100);
    }

    private void OnTargetDateChanged(ChangeEventArgs e)
    {
        goalTargetDateString = e.Value?.ToString() ?? "";
    }

    private void OnEditTargetDateChanged(ChangeEventArgs e)
    {
        editGoalTargetDateString = e.Value?.ToString() ?? "";
    }

    private void OnContributionDateChanged(ChangeEventArgs e)
    {
        contributionDateString = e.Value?.ToString() ?? "";
    }
}
