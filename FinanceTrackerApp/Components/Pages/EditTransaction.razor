@page "/edit-transaction/{TransactionId:guid}"
@attribute [Authorize]
@using FinanceTrackerApp.Models
@using FinanceTrackerApp.Services
@inject TransactionService TransactionService
@inject NavigationManager NavigationManager

<div class="glass card" style="padding:1rem; max-width:500px; margin:auto;">
    <h2 class="strong" style="color: var(--text);">Edit Transaction</h2>
    <p style=" margin-bottom: 15px">Need to make a change? Edit your transaction below.</p>

    @if (editTx == null)
    {
        <p>Loading...</p>
    }
    else
    {
        <EditForm Model="@editTx" OnValidSubmit="SaveTransaction">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="form-grid" style="display:grid; gap:.5rem;">
                <div class="field">
                    <label>Amount (USD)</label>
                    <input class="input" type="number" @bind="editTx.Amount" />
                </div>

                <div class="field">
                    <label>Type</label>
                    <select class="input" @bind="editTx.Type">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>

                <div class="field">
                    <label>Date</label>
                    <input type="date" class="input" @bind="editTx.Date" />
                </div>

            <!-- Conditional Categories -->
                <div class="field">
                    <label>Category</label>
                    @if (editTx.Type == "expense")
                    {
                        <select class="input" @bind="editTx.Category">
                            <option value="" disabled selected hidden>Select an expense category</option>
                            <option value="Food">Food</option>
                            <option value="Bills">Bills</option>
                            <option value="Health / Medical">Health / Medical</option>
                            <option value="Personal">Personal</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Housing / Rent">Housing / Rent</option>
                            <option value="Transportation">Transportation</option>
                        </select>
                    }
                    else if (editTx.Type == "income")
                    {
                        <select class="input" @bind="editTx.Category">
                            <option value="" disabled selected hidden>Select an income category</option>
                            <option value="Salary">Salary</option>
                            <option value="Bonus">Bonus</option>
                            <option value="Freelance">Freelance</option>
                            <option value="Investment">Investment</option>
                        </select>
                    }
                </div>

                <div class="field">
                    <label>Description</label>
                    <input class="input" type="text" @bind="editTx.Description" />
                </div>

                <div style="margin-top:1rem; margin: auto;">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-ghost" @onclick="Cancel">Cancel</button>
                </div>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter] public Guid TransactionId { get; set; }
    private Transaction? editTx;

    protected override async Task OnInitializedAsync()
    {
        editTx = await TransactionService.GetByIdAsync(TransactionId);
    }

    private async Task SaveTransaction()
    {
        if (editTx == null) return;

        await TransactionService.UpdateAsync(editTx);
        NavigationManager.NavigateTo("/transactions");
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/transactions");
    }
}
