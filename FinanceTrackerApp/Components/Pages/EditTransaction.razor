@page "/edit-transaction/{TransactionId:guid}"
@attribute [Authorize]
@using FinanceTrackerApp.Models
@using FinanceTrackerApp.Services
@inject TransactionService TransactionService
@inject AuthService AuthService
@inject CategoryService CategoryService
@inject NavigationManager NavigationManager

<div class="glass card" style="padding:1rem; max-width:500px; margin:auto;">
    @if (!string.IsNullOrWhiteSpace(formError))
    {
        <div class="alert">@formError</div>
    }
    <h2 class="strong" style="color: var(--text);">Edit Transaction</h2>
    <p style=" margin-bottom: 15px">Need to make a change? Edit your transaction below.</p>

    @if (editTx == null)
    {
        <p>Loading...</p>
    }
    else
    {
        <EditForm Model="@editTx" OnValidSubmit="SaveTransaction">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="form-grid" style="display:grid; gap:.5rem;">
                <div class="field">
                    <label>Amount (USD)</label>
                    <input class="input" type="number" @bind="editTx.Amount" />
                </div>

                <div class="field">
                    <label>Type</label>
                    <select class="input" @bind="editTx.Type">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                </div>

                <div class="field">
                    <label>Date</label>
                    <input type="date" class="input" @bind="editTx.Date" />
                </div>

                <div class="field">
                    <label>Category</label>
                    <div style="display:flex; gap:.5rem; align-items:center;">
                        <select class="input" @bind="editTx.Category" style="flex:1;">
                            @foreach (var category in CategoryOptions)
                            {
                                <option value="@category">@category</option>
                            }
                        </select>
                        <button type="button" class="btn btn-xs" @onclick="OpenQuickAddCategory">+ New</button>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(categoryMessage))
                    {
                        <small class="muted">@categoryMessage</small>
                    }
                </div>

                <div class="field">
                    <label>Description</label>
                    <input class="input" type="text" @bind="editTx.Description" />
                </div>

                <div style="margin-top:1rem; margin: auto;">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-ghost" @onclick="Cancel">Cancel</button>
                </div>
            </div>
        </EditForm>
    }
</div>

<Modal @bind-IsOpen="isCategoryModalOpen" Title="Add Category">
    <ChildContent>
        <div class="form-grid">
            <div class="field">
                <label>Name</label>
                <input class="input" @bind="newCategoryName" placeholder="e.g. Groceries" />
            </div>
            <div class="field">
                <label>Color</label>
                <input class="input" type="color" @bind="newCategoryColor" />
            </div>
        </div>
    </ChildContent>
    <FooterContent>
        <button class="btn btn-ghost" @onclick="CloseQuickAddCategory">Cancel</button>
        <button class="btn btn-primary" @onclick="SaveQuickCategoryAsync">Save Category</button>
    </FooterContent>
</Modal>

@code {
    [Parameter] public Guid TransactionId { get; set; }
    private Transaction? editTx;
    private string currentUserId = "";
    private List<Category> userCategories = new();
    private bool isCategoryModalOpen;
    private string newCategoryName = "";
    private string newCategoryColor = "#2BEF83";
    private string categoryMessage = "";
    private string formError = "";

    protected override async Task OnInitializedAsync()
    {
        currentUserId = await AuthService.GetCurrentUserIdAsync();
        await LoadCategoriesAsync();
        editTx = await TransactionService.GetByIdAsync(TransactionId);
        if (editTx != null && string.IsNullOrWhiteSpace(editTx.Category))
        {
            editTx.Category = CategoryOptions.FirstOrDefault() ?? "General";
        }
    }

    private async Task SaveTransaction()
    {
        if (editTx == null) return;
        formError = "";
        try
        {
            await TransactionService.UpdateAsync(editTx);
            NavigationManager.NavigateTo("/transactions");
        }
        catch
        {
            formError = "Could not update transaction right now. Please try again.";
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/transactions");
    }

    private async Task LoadCategoriesAsync()
    {
        userCategories = await CategoryService.GetByUserAsync(currentUserId);
    }

    private IEnumerable<string> CategoryOptions =>
        userCategories
            .Select(c => c.Name)
            .Where(name => !string.IsNullOrWhiteSpace(name))
            .DefaultIfEmpty("General")
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(name => name);

    private void OpenQuickAddCategory()
    {
        categoryMessage = "";
        newCategoryName = "";
        newCategoryColor = "#2BEF83";
        isCategoryModalOpen = true;
    }

    private void CloseQuickAddCategory()
    {
        isCategoryModalOpen = false;
    }

    private async Task SaveQuickCategoryAsync()
    {
        var name = (newCategoryName ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(name))
        {
            categoryMessage = "Category name is required.";
            return;
        }

        if (userCategories.Any(c => string.Equals(c.Name, name, StringComparison.OrdinalIgnoreCase)))
        {
            categoryMessage = "Category already exists.";
            return;
        }

        await CategoryService.AddAsync(new Category { Name = name, Color = newCategoryColor }, currentUserId);
        await LoadCategoriesAsync();
        if (editTx != null)
        {
            editTx.Category = name;
        }
        categoryMessage = $"Added '{name}'.";
        isCategoryModalOpen = false;
    }
}
